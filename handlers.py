import asyncio

import aiogram
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters import Command, CommandStart, Text
from aiogram.types import InlineKeyboardMarkup, ReplyKeyboardRemove, User, Chat, CallbackQuery

import handlers_item
import states
from button_manager import create_general_reply_markup, general_buttons_folder, skip_enter_item_title_button, \
    cancel_add_new_item_button
from enums import Environment
from firebase import add_user
from firebase_folder_reader import ROOT_FOLDER_ID, get_current_folder_id
from firebase_folder_writer import set_current_folder
from handlers_folder import create_folder_button, on_delete_folder, show_all_folders, show_folders
from load_all import dp, bot
from models import Item
from utils import get_environment, get_inline_markup_items_in_folder, get_inline_markup_folders
from utils_folders_db import util_get_user_folders, get_folder_path_names
from utils_items import show_all_items


# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–ª—å—Ç—Ä CommandStart –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /start
@dp.message_handler(CommandStart())
async def start(message: aiogram.types.Message, state: FSMContext):
    await state.reset_data()
    await state.reset_state()

    chat_id = message.from_user.id
    tg_user = aiogram.types.User.get_current()
    await add_user(tg_user)

    bot_username = (await bot.me).username

    text = (f"–ü—Ä–∏–≤–µ—Çüëã, {tg_user.first_name}, –¥–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º! üöÄÔ∏è\n\n–î–ª—è –í–∞—Å —Å–æ–∑–¥–∞–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, "
            f"–∫–æ—Ç–æ—Ä–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /storage\n\n"
            f"–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ üíº, —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø–∞–ø–∫–∏ üóÇÔ∏è –∏ –∑–∞–ø–∏—Å–∏ üìÑ, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫–∏ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µüì±\n\n"
            f"–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞ –∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –ú–µ–Ω—é —Ä—è–¥–æ–º —Å –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ‚ÜôÔ∏è\n\n"
            f"–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è! ‚ò∫Ô∏è")
    await bot.send_message(chat_id, text, reply_markup=ReplyKeyboardRemove())


# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–ª—å—Ç—Ä CommandStart –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /storage
@dp.message_handler(commands=["storage"])
async def storage(message: aiogram.types.Message, state: FSMContext):
    await state.reset_data()
    await state.reset_state()

    tg_user = User.get_current()
    chat = Chat.get_current()
    user_folders = await util_get_user_folders()

    await set_current_folder(tg_user.id, ROOT_FOLDER_ID)

    folder_buttons = [
        await create_folder_button(folder_id, folder_data.get("name"))
        for folder_id, folder_data in user_folders.items()
    ]
    markup = create_general_reply_markup(general_buttons_folder)

    current_folder_path_names = await get_folder_path_names()
    await bot.send_message(chat.id, f"üóÇÔ∏è", reply_markup=markup)
    folders_inline_markup = await get_inline_markup_folders(folder_buttons, 1)

    folders_message = await bot.send_message(chat.id, f"üóÇÔ∏è <b>{current_folder_path_names}</b>",
                                             reply_markup=folders_inline_markup)

    #load_message = await bot.send_message(chat.id, f"‚åõÔ∏è")
    items_inline_markup = await get_inline_markup_items_in_folder(ROOT_FOLDER_ID, 1)
    if items_inline_markup.inline_keyboard:
        for row in items_inline_markup.inline_keyboard:
            folders_inline_markup.add(*row)
        await folders_message.edit_reply_markup(reply_markup=folders_inline_markup)

    #await bot.delete_message(chat_id=chat.id, message_id=load_message.message_id)
    folders_message.reply_markup = folders_inline_markup
    await dp.storage.update_data(user=tg_user, chat=chat,
                                 data={'current_keyboard': markup, 'folders_message': folders_message,
                                       'page_folders': str(1), 'page_items': str(1)})


@dp.callback_query_handler(text_contains="show_all")
async def show_all_entities_handler(call: CallbackQuery):
    if 'folders' in call.data:
        await show_all_folders()
    elif 'items' in call.data:
        await show_all_items()


@dp.message_handler(Text(equals="Ô∏è‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –æ–±—â–µ–º—É –≤–∏–¥—É –ø–∞–ø–∫–∏"))
async def back_to_folder(message: aiogram.types.Message):
    tg_user = User.get_current()
    folder_id = await get_current_folder_id(tg_user.id)
    await show_folders(folder_id, page_folder=1, page_item=1)


@dp.message_handler(Text(contains="üóë –£–¥–∞–ª–∏—Ç—å"))
async def delete_handler(message: aiogram.types.Message):
    environment = await get_environment()

    if environment == Environment.FOLDERS:
        await on_delete_folder(message)
    elif environment == Environment.ITEM_CONTENT:
        await handlers_item.on_delete_item(message)


@dp.message_handler(~Command(["start", "storage"]))
async def any_message(message: aiogram.types.Message, state: FSMContext):
    buttons = [[skip_enter_item_title_button, cancel_add_new_item_button]]
    inline_markup = InlineKeyboardMarkup(row_width=1, inline_keyboard=buttons)
    add_item_message_1 = await bot.send_message(message.chat.id, "–°–µ–π—á–∞—Å —Å–æ—Ö—Ä–∞–Ω–∏–º –í–∞—à—É –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å üëå",
                                                reply_markup=ReplyKeyboardRemove())
    await asyncio.sleep(0.8)
    add_item_message_2 = await bot.send_message(message.chat.id, "–î–æ–±–∞–≤—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫:",
                                                reply_markup=inline_markup)
    item = Item(message.text)

    await state.update_data(item=item, add_item_messages=(add_item_message_1, add_item_message_2))

    await states.Item.NewStepTitle.set()

